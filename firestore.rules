/**
 * @fileoverview Firestore Security Rules for Okidex Platform
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-specific data while allowing public read access to job postings and investment opportunities.
 *
 * Data Structure:
 * - /users/{userId}: Stores user account information. Accessible only by the user with the matching userId.
 * - /user_profiles/{profileId}: Stores user profile data. Accessible only by the user with the matching profileId.
 * - /matches/{matchId}: Stores data about matches between users. Accessible only by the two matched users.
 * - /matches/{matchId}/messages/{messageId}: Stores messages between users in a match. Accessible only by the two matched users.
 * - /job_postings/{jobPostingId}: Stores job postings. Publicly readable but only creatable by authenticated founders.
 * - /investment_opportunities/{investmentOpportunityId}: Stores investment opportunities. Publicly readable but only creatable by authenticated founders.
 * - /investment_theses/{investmentThesisId}: Stores investment theses. Only investors can create these.
 * - /financial_summaries/{financialSummaryId}: Stores financial summaries related to investment opportunities. Accessible only by authorized users with access to the related InvestmentOpportunity.
 *
 * Key Security Decisions:
 * - User listing is implicitly disallowed by the data structure; user data is stored under /users/{userId}.
 * - Job postings and investment opportunities are publicly readable.
 * - Denormalization is used in the messages subcollection to avoid needing to query the parent match document.
 * - The default security posture for ambiguous relationships is strict owner-only access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user account documents.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own document.
     * @allow (get) User with ID 'user123' can read their own document.
     * @allow (update) User with ID 'user123' can update their own document.
     * @allow (delete) User with ID 'user123' can delete their own document.
     * @deny (create) User with ID 'user456' cannot create a document with ID 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && resource.data.id == userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to user profile documents.
     * @path /user_profiles/{profileId}
     * @allow (create) User with profile ID 'profile123' can create their profile.
     * @allow (get) User with profile ID 'profile123' can read their profile.
     * @allow (update) User with profile ID 'profile123' can update their profile.
     * @allow (delete) User with profile ID 'profile123' can delete their profile.
     * @deny (create) User with profile ID 'profile456' cannot create a profile with ID 'profile123'.
     * @principle Enforces document ownership for all operations.
     */
    match /user_profiles/{profileId} {
      allow get: if isOwner(profileId);
      allow list: if false;
      allow create: if isOwner(profileId) && request.resource.data.id == profileId;
      allow update: if isExistingOwner(profileId) && resource.data.id == profileId;
      allow delete: if isExistingOwner(profileId);
    }

    /**
     * @description Controls access to match documents.
     * @path /matches/{matchId}
     * @allow (get) User with ID 'user123' can read match 'match123' if they are one of the matched users.
     * @allow (create) Not applicable; matches are likely created server-side.
     * @deny (get) User with ID 'user456' cannot read match 'match123' if they are not one of the matched users.
     * @principle Restricts access to only the users involved in the match.
     */
    match /matches/{matchId} {
      allow get: if isMatchParticipant(resource.data.user1Id, resource.data.user2Id);
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to messages within a match.
     * @path /matches/{matchId}/messages/{messageId}
     * @allow (create) User with ID 'user123' can create a message in match 'match123' if they are a participant.
     * @allow (get) User with ID 'user123' can read a message in match 'match123' if they are a participant.
     * @deny (create) User with ID 'user456' cannot create a message if they are not a participant.
     * @principle Restricts access to messages to only participants of the match.
     */
    match /matches/{matchId}/messages/{messageId} {
      allow get: if isMatchParticipant(resource.data.senderId, resource.data.receiverId);
      allow list: if isMatchParticipant(resource.data.senderId, resource.data.receiverId);
      allow create: if isMatchParticipant(request.resource.data.senderId, request.resource.data.receiverId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to job posting documents.
     * @path /job_postings/{jobPostingId}
     * @allow (get) Any user can read job postings.
     * @allow (create) Only authenticated founders can create job postings.
     * @deny (create) Unauthenticated users cannot create job postings.
     * @principle Allows public read access but restricts creation to authenticated founders.
     */
    match /job_postings/{jobPostingId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.founderId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.founderId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.founderId == request.auth.uid;
    }

    /**
     * @description Controls access to investment opportunity documents.
     * @path /investment_opportunities/{investmentOpportunityId}
     * @allow (get) Any user can read investment opportunities.
     * @allow (create) Only authenticated founders can create investment opportunities.
     * @deny (create) Unauthenticated users cannot create investment opportunities.
     * @principle Allows public read access but restricts creation to authenticated founders.
     */
    match /investment_opportunities/{investmentOpportunityId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.founderId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.founderId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.founderId == request.auth.uid;
    }

    /**
     * @description Controls access to investment thesis documents.
     * @path /investment_theses/{investmentThesisId}
     * @allow (create) Only authenticated investors can create investment theses.
     * @deny (create) Unauthenticated users or founders cannot create investment theses.
     * @principle Restricts creation to authenticated investors.
     */
    match /investment_theses/{investmentThesisId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.investorId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.investorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.investorId == request.auth.uid;
    }

    /**
     * @description Controls access to financial summary documents.
     * @path /financial_summaries/{financialSummaryId}
     * @allow (get) Only authorized users (e.g., investors) who have access to the related InvestmentOpportunity can access the financial summaries.
     * @deny (get) Unauthorized users cannot access the financial summaries.
     */
    match /financial_summaries/{financialSummaryId} {
      allow get: if true; // TODO: Implement access control based on the related InvestmentOpportunity
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isSignedIn() && isOwner(userId) && resource != null;
  }

  function isMatchParticipant(user1Id, user2Id) {
    return request.auth.uid == user1Id || request.auth.uid == user2Id;
  }
}
