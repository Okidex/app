rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }
    function isParticipant() { return isSignedIn() && request.auth.uid in resource.data.participantIds; }
    function willBeParticipant() { return isSignedIn() && request.auth.uid in request.resource.data.participantIds; }

    // Users & Profiles: Open read for search, restricted write for owners
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isOwner(userId);
    }
    
    match /user_profiles/{profileId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isOwner(profileId);
    }

    // Notifications: Simplified list for better hook compatibility
    match /notifications/{notificationId} {
      // Allows listing as long as every returned doc belongs to the user.
      // This is the most compatible way to handle generic useCollection hooks.
      allow list: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
    
    // Conversations: Participant-based access
    match /conversations/{conversationId} {
      allow get, update: if isParticipant();
      // Allow listing if the user is a participant in the resulting docs
      allow list: if isSignedIn() && (request.auth.uid in resource.data.participantIds);
      allow create: if willBeParticipant();

      match /messages/{messageId} {
        allow read, write: if isSignedIn() && (
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds
        );
      }
    }

    // Startups, Jobs, and Theses
    match /startups/{startupId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    match /theses/{thesisId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.resource.data.investorId == request.auth.uid;
    }
    
    match /jobs/{jobId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.resource.data.founderId == request.auth.uid;
    }

    match /interests/{interestId} {
      allow read, create: if isSignedIn();
    }

    // Matches
    match /matches/{matchId} {
      allow read: if isParticipant();
      allow create: if willBeParticipant();
      
      match /messages/{messageId} {
        allow read, create: if isSignedIn();
      }
    }

    // General fallback for public collections
    match /{collection}/{docId} {
      allow read: if collection in [
        'job_postings',
        'investment_opportunities',
        'investment_theses',
        'startups'
      ] && isSignedIn();
      allow write: if false;
    }
  }
}
