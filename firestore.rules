/**
 * @fileoverview Firestore Security Rules for Okidex Platform
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for personal data and role-based access for other content, such as job postings and investment opportunities.
 *
 * Data Structure:
 * - User data is stored under /users/{userId} and /user_profiles/{profileId}, accessible only to the authenticated user.
 * - Matches are stored in /matches/{matchId} and messages are stored in the subcollection /matches/{matchId}/messages/{messageId}, accessible only to the users involved in the match.
 * - Job postings and investment opportunities are stored in top-level collections (/job_postings/{jobPostingId} and /investment_opportunities/{investmentOpportunityId}), with create access restricted to authenticated founders and read access potentially open or role-based.
 * - Investment theses are stored in /investment_theses/{investmentThesisId}, with create access restricted to investors.
 * - Financial summaries are stored in /financial_summaries/{financialSummaryId}, with access potentially restricted to investors (requires validation in conjunction with InvestmentOpportunity).
 *
 * Key Security Decisions:
 * - Users can only access their own user and profile data.
 * - Matches and messages are restricted to participating users.
 * - Job postings, investment opportunities, and investment theses have role-based write access (founders/investors).
 * - Listing of user documents is disallowed.
 *
 * Denormalization for Authorization:
 * - Messages include denormalized 'senderId' and 'receiverId' to enable direct authorization checks without requiring access to the parent 'Match' document.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Ensures only the authenticated user can access their own user document.
     * @path /users/{userId}
     */
    match /users/{userId} {
      // Helper function to check if the requesting user is the owner of the document
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Ensures only the authenticated user can access their own user profile.
     * @path /user_profiles/{profileId}
     */
    match /user_profiles/{profileId} {
      allow get: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.profileId == profileId;
      allow list: if false;
      allow create: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.profileId == profileId;
      allow update: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.profileId == profileId;
      allow delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.profileId == profileId;
    }

    /**
     * @description Ensures that only the users involved in a match can access the match document.
     * @path /matches/{matchId}
     */
    match /matches/{matchId} {
      // Helper function to check if the requesting user is a participant in the match
      function isParticipant() {
        return request.auth != null && (resource.data.user1Id == request.auth.uid || resource.data.user2Id == request.auth.uid);
      }

      allow get: if get(/databases/$(database)/documents/matches/$(matchId)).data.user1Id == request.auth.uid || get(/databases/$(database)/documents/matches/$(matchId)).data.user2Id == request.auth.uid;
      allow list: if false;
      allow create: if false; // Matches are likely created server-side
      allow update: if get(/databases/$(database)/documents/matches/$(matchId)).data.user1Id == request.auth.uid || get(/databases/$(database)/documents/matches/$(matchId)).data.user2Id == request.auth.uid;
      allow delete: if get(/databases/$(database)/documents/matches/$(matchId)).data.user1Id == request.auth.uid || get(/databases/$(database)/documents/matches/$(matchId)).data.user2Id == request.auth.uid;
    }

    /**
     * @description Ensures only users involved in the match can access messages.
     * @path /matches/{matchId}/messages/{messageId}
     */
    match /matches/{matchId}/messages/{messageId} {
      // Helper function to check if the requesting user is a participant in the match
      function isMessageParticipant() {
        return request.auth != null && (get(/databases/$(database)/documents/matches/$(matchId)/messages/$(messageId)).data.senderId == request.auth.uid || get(/databases/$(database)/documents/matches/$(matchId)/messages/$(messageId)).data.receiverId == request.auth.uid);
      }

      // Helper function to check if the requesting user is the sender of the message being created
      function isSender() {
        return request.auth != null && request.resource.data.senderId == request.auth.uid;
      }

      allow get: if get(/databases/$(database)/documents/matches/$(matchId)/messages/$(messageId)).data.senderId == request.auth.uid || get(/databases/$(database)/documents/matches/$(matchId)/messages/$(messageId)).data.receiverId == request.auth.uid;
      allow list: if get(/databases/$(database)/documents/matches/$(matchId)/messages/$(messageId)).data.senderId == request.auth.uid || get(/databases/$(database)/documents/matches/$(matchId)/messages/$(messageId)).data.receiverId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.senderId == request.auth.uid && request.resource.data.matchId == matchId;
      allow update: if false;  //Messages should not be updatable
      allow delete: if false;  //Messages should not be deletable
    }

    /**
     * @description Allows authenticated users to create job postings, with founderId matching their UID.
     * @path /job_postings/{jobPostingId}
     */
    match /job_postings/{jobPostingId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.auth != null && request.resource.data.founderId == request.auth.uid;
      allow update: if request.auth != null && get(/databases/$(database)/documents/job_postings/$(jobPostingId)).data.founderId == request.auth.uid;
      allow delete: if request.auth != null && get(/databases/$(database)/documents/job_postings/$(jobPostingId)).data.founderId == request.auth.uid;
    }

    /**
     * @description Allows authenticated users to create investment opportunities, with founderId matching their UID.
     * @path /investment_opportunities/{investmentOpportunityId}
     */
    match /investment_opportunities/{investmentOpportunityId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.auth != null && request.resource.data.founderId == request.auth.uid;
      allow update: if request.auth != null && get(/databases/$(database)/documents/investment_opportunities/$(investmentOpportunityId)).data.founderId == request.auth.uid;
      allow delete: if request.auth != null && get(/databases/$(database)/documents/investment_opportunities/$(investmentOpportunityId)).data.founderId == request.auth.uid;
    }

    /**
     * @description Allows authenticated users to create investment theses, with investorId matching their UID.
     * @path /investment_theses/{investmentThesisId}
     */
    match /investment_theses/{investmentThesisId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.auth != null && request.resource.data.investorId == request.auth.uid;
      allow update: if request.auth != null && get(/databases/$(database)/documents/investment_theses/$(investmentThesisId)).data.investorId == request.auth.uid;
      allow delete: if request.auth != null && get(/databases/$(database)/documents/investment_theses/$(investmentThesisId)).data.investorId == request.auth.uid;
    }

    /**
     * @description Restricts access to financial summaries.  Access should be linked to the InvestmentOpportunity.
     * @path /financial_summaries/{financialSummaryId}
     */
    match /financial_summaries/{financialSummaryId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}
